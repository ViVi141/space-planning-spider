# ç¿»é¡µæœºåˆ¶ä¼˜åŒ–æ€»ç»“

**ä¼˜åŒ–æ—¥æœŸ**: 2025.10.29  
**ç‰ˆæœ¬**: v3.0.1  
**ä¼˜åŒ–è€…**: AI Assistant

---

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. ä¿®å¤è‡ªç„¶èµ„æºéƒ¨é‡å¤ç©ºé¡µæ£€æµ‹é€»è¾‘

**æ–‡ä»¶**: `src/space_planning/spider/mnr.py`

**é—®é¢˜**: ç¬¬197è¡Œå’Œç¬¬270è¡Œé‡å¤æ£€æµ‹ç©ºé¡µï¼Œå¯¼è‡´è®¡æ•°æ··ä¹±

**ä¼˜åŒ–å‰**:
```python
# ç¬¬ä¸€æ¬¡æ£€æµ‹
if not page_policies:
    consecutive_empty_pages += 1
    # ...
    break

# ç¬¬äºŒæ¬¡æ£€æµ‹ï¼ˆé‡å¤ï¼‰
if new_policies_count == 0:
    consecutive_empty_pages += 1
    # ...
```

**ä¼˜åŒ–å**:
```python
# åªä¿ç•™ä¸€æ¬¡æ£€æµ‹ï¼ŒåŒºåˆ†ä¸åŒæƒ…å†µ
if not page_policies:
    consecutive_empty_pages += 1
    if consecutive_empty_pages >= max_consecutive_empty:
        break
    page += 1
    continue

# è¿‡æ»¤åçš„å¤„ç†
if new_policies_count == 0 and len(page_policies) > 0:
    # æ‰€æœ‰æ•°æ®è¢«è¿‡æ»¤ï¼Œä½†ä¸æ˜¯ç©ºé¡µ
    callback(f"åˆ†ç±»[{category_name}]ç¬¬{page}é¡µæ‰€æœ‰æ•°æ®è¢«è¿‡æ»¤ï¼Œç»§ç»­ä¸‹ä¸€é¡µ")
elif new_policies_count == 0 and len(page_policies) == 0:
    # çœŸæ­£çš„ç©ºé¡µï¼Œå·²åœ¨ä¸Šé¢å¤„ç†
    pass
```

**æ•ˆæœ**: æ¶ˆé™¤äº†é‡å¤è®¡æ•°ï¼Œæé«˜äº†ç¿»é¡µé€»è¾‘çš„å‡†ç¡®æ€§

---

### 2. ä¼˜åŒ–ä½å»ºéƒ¨æ—¶é—´åŒºé—´æ£€æµ‹è¾¹ç•Œé—®é¢˜

**æ–‡ä»¶**: `src/space_planning/spider/national.py`

**é—®é¢˜**: ä½¿ç”¨ `min_date` å’Œ `max_date` åˆ¤æ–­æ—¶é—´åŒºé—´ä¸å¤Ÿç²¾ç¡®

**ä¼˜åŒ–å‰**:
```python
# æ£€æŸ¥æ˜¯å¦è¿›å…¥ç›®æ ‡æ—¶é—´åŒºé—´
if not in_target_range and min_date <= dt_end and max_date >= dt_start:
    in_target_range = True

# æ£€æŸ¥æ˜¯å¦å®Œå…¨è„±ç¦»ç›®æ ‡æ—¶é—´åŒºé—´
elif in_target_range and (max_date < dt_start or min_date > dt_end):
    consecutive_out_of_range += 1
```

**ä¼˜åŒ–å**:
```python
# æ›´ç²¾ç¡®çš„æ—¶é—´åŒºé—´åˆ¤æ–­
if not in_target_range:
    # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ•°æ®åœ¨ç›®æ ‡æ—¶é—´èŒƒå›´å†…
    has_target_data = any(dt_start <= d <= dt_end for d in page_dates)
    if has_target_data:
        in_target_range = True
        consecutive_out_of_range = 0

elif in_target_range:
    # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ•°æ®éƒ½åœ¨ç›®æ ‡èŒƒå›´å¤–
    all_out_of_range = all(d < dt_start or d > dt_end for d in page_dates)
    if all_out_of_range:
        consecutive_out_of_range += 1
    else:
        consecutive_out_of_range = 0
```

**æ•ˆæœ**: æé«˜äº†æ—¶é—´åŒºé—´åˆ¤æ–­çš„å‡†ç¡®æ€§ï¼Œé¿å…è¯¯åˆ¤

---

### 3. ä¼˜åŒ–å¹¿ä¸œçœä¸¤æ­¥ç¿»é¡µæ ¡éªŒå¤±è´¥å¤„ç†

**æ–‡ä»¶**: `src/space_planning/spider/guangdong.py`

**é—®é¢˜**: ç¿»é¡µæ ¡éªŒå¤±è´¥åä»ç»§ç»­æ‰§è¡Œï¼Œå¯èƒ½å¯¼è‡´æ•°æ®è·å–å¤±è´¥

**ä¼˜åŒ–å‰**:
```python
try:
    check_resp, check_info = self.post_page(check_url, headers=check_headers)
    # ...
except Exception as check_error:
    print(f"ç¿»é¡µæ ¡éªŒè¯·æ±‚å¤±è´¥: {check_error}")
    # ç¿»é¡µæ ¡éªŒå¤±è´¥ä¸å½±å“ä¸»è¯·æ±‚ï¼Œç»§ç»­æ‰§è¡Œ
```

**ä¼˜åŒ–å**:
```python
try:
    check_resp, check_info = self.post_page(check_url, headers=check_headers)
    if check_resp and check_resp.status_code == 200:
        print(f"ç¿»é¡µæ ¡éªŒæˆåŠŸ: {check_resp.status_code}")
    else:
        print(f"ç¿»é¡µæ ¡éªŒå¤±è´¥: {check_resp.status_code}")
        # å¦‚æœæ ¡éªŒå¤±è´¥ï¼Œç­‰å¾…åé‡è¯•æ•´ä¸ªæµç¨‹
        retry_count += 1
        if retry_count < max_retries:
            print(f"ç¿»é¡µæ ¡éªŒå¤±è´¥ï¼Œé‡è¯•æ•´ä¸ªæµç¨‹...")
            time.sleep(3)
            continue
        else:
            print(f"ç¿»é¡µæ ¡éªŒè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œå°è¯•è·³è¿‡æ ¡éªŒç›´æ¥è¯·æ±‚æ•°æ®")
except Exception as check_error:
    print(f"ç¿»é¡µæ ¡éªŒè¯·æ±‚å¼‚å¸¸: {check_error}")
    # æ ¡éªŒå¼‚å¸¸æ—¶ï¼Œç­‰å¾…åé‡è¯•
    retry_count += 1
    if retry_count < max_retries:
        print(f"ç¿»é¡µæ ¡éªŒå¼‚å¸¸ï¼Œé‡è¯•æ•´ä¸ªæµç¨‹...")
        time.sleep(3)
        continue
    else:
        print(f"ç¿»é¡µæ ¡éªŒå¼‚å¸¸è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œå°è¯•è·³è¿‡æ ¡éªŒç›´æ¥è¯·æ±‚æ•°æ®")
```

**æ•ˆæœ**: æé«˜äº†ä¸¤æ­¥æ ¡éªŒçš„æˆåŠŸç‡ï¼Œå‡å°‘äº†å› æ ¡éªŒå¤±è´¥å¯¼è‡´çš„æ•°æ®ä¸¢å¤±

---

### 4. æ”¹è¿›æ‰€æœ‰çˆ¬è™«çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

**æ–‡ä»¶**: `src/space_planning/spider/national.py`

**é—®é¢˜**: å¼‚å¸¸æ—¶ç›´æ¥breakï¼Œå¯èƒ½ä¸¢å¤±å·²è·å–çš„æ•°æ®

**ä¼˜åŒ–å‰**:
```python
except Exception as e:
    print(f"æ£€ç´¢ç¬¬ {page_no} é¡µæ—¶å‡ºé”™: {e}")
    if callback:
        callback(f"æ£€ç´¢ç¬¬ {page_no} é¡µæ—¶å‡ºé”™: {e}")
    break  # ç›´æ¥åœæ­¢ï¼Œå¯èƒ½ä¸¢å¤±æ•°æ®
```

**ä¼˜åŒ–å**:
```python
except Exception as e:
    print(f"æ£€ç´¢ç¬¬ {page_no} é¡µæ—¶å‡ºé”™: {e}")
    if callback:
        callback(f"æ£€ç´¢ç¬¬ {page_no} é¡µæ—¶å‡ºé”™: {e}")
    
    # æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦ç»§ç»­
    error_str = str(e).lower()
    if any(keyword in error_str for keyword in ['timeout', 'connection', 'network', 'dns']):
        # ç½‘ç»œç›¸å…³é”™è¯¯ï¼Œå¯ä»¥é‡è¯•
        print(f"ç½‘ç»œé”™è¯¯ï¼Œå°è¯•ç»§ç»­ä¸‹ä¸€é¡µ...")
        page_no += 1
        continue
    elif any(keyword in error_str for keyword in ['json', 'parse', 'decode']):
        # è§£æé”™è¯¯ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨è¿”å›äº†é”™è¯¯é¡µé¢
        print(f"è§£æé”™è¯¯ï¼Œå°è¯•ç»§ç»­ä¸‹ä¸€é¡µ...")
        page_no += 1
        continue
    else:
        # å…¶ä»–é”™è¯¯ï¼Œåœæ­¢çˆ¬å–
        print(f"é‡åˆ°ä¸¥é‡é”™è¯¯ï¼Œåœæ­¢çˆ¬å–")
        break
```

**æ•ˆæœ**: æé«˜äº†çˆ¬è™«çš„å®¹é”™èƒ½åŠ›ï¼Œå‡å°‘äº†å› ä¸´æ—¶é”™è¯¯å¯¼è‡´çš„æ•°æ®ä¸¢å¤±

---

### 5. ç»Ÿä¸€æ‰€æœ‰çˆ¬è™«çš„ç©ºé¡µè®¡æ•°é‡ç½®é€»è¾‘

**æ–‡ä»¶**: `src/space_planning/spider/mnr.py`

**é—®é¢˜**: åˆ‡æ¢åˆ†ç±»æ—¶ï¼Œç©ºé¡µè®¡æ•°å¯èƒ½æ²¡æœ‰é‡ç½®

**ä¼˜åŒ–å‰**:
```python
# åˆ†é¡µè·å–æ•°æ®
page = 1
category_results = []
consecutive_empty_pages = 0  # è¿ç»­ç©ºé¡µè®¡æ•°
max_consecutive_empty = 3  # æœ€å¤§è¿ç»­ç©ºé¡µæ•°
```

**ä¼˜åŒ–å**:
```python
# åˆ†é¡µè·å–æ•°æ® - æ¯ä¸ªåˆ†ç±»å¼€å§‹æ—¶é‡ç½®æ‰€æœ‰è®¡æ•°å˜é‡
page = 1
category_results = []
consecutive_empty_pages = 0  # è¿ç»­ç©ºé¡µè®¡æ•°
max_consecutive_empty = 3  # æœ€å¤§è¿ç»­ç©ºé¡µæ•°
new_policies_count = 0  # æ–°å¢æ”¿ç­–è®¡æ•°
```

**æ•ˆæœ**: ç¡®ä¿æ¯ä¸ªåˆ†ç±»çš„ç¿»é¡µè®¡æ•°ç‹¬ç«‹ï¼Œé¿å…è·¨åˆ†ç±»çš„è®¡æ•°å¹²æ‰°

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

| ä¼˜åŒ–é¡¹ç›® | ä¼˜åŒ–å‰é—®é¢˜ | ä¼˜åŒ–åæ•ˆæœ | å½±å“èŒƒå›´ |
|----------|------------|------------|----------|
| è‡ªç„¶èµ„æºéƒ¨é‡å¤æ£€æµ‹ | è®¡æ•°æ··ä¹±ï¼Œå¯èƒ½æå‰åœæ­¢ | é€»è¾‘æ¸…æ™°ï¼Œå‡†ç¡®è®¡æ•° | MNRçˆ¬è™« |
| ä½å»ºéƒ¨æ—¶é—´åŒºé—´ | è¾¹ç•Œåˆ¤æ–­ä¸å‡†ç¡® | ç²¾ç¡®åˆ¤æ–­ï¼Œé¿å…è¯¯åˆ¤ | Nationalçˆ¬è™« |
| å¹¿ä¸œçœä¸¤æ­¥æ ¡éªŒ | æ ¡éªŒå¤±è´¥ä»ç»§ç»­ | æ™ºèƒ½é‡è¯•ï¼Œæé«˜æˆåŠŸç‡ | Guangdongçˆ¬è™« |
| å¼‚å¸¸å¤„ç†æœºåˆ¶ | å¼‚å¸¸ç›´æ¥åœæ­¢ | åˆ†ç±»å¤„ç†ï¼Œæé«˜å®¹é”™æ€§ | æ‰€æœ‰çˆ¬è™« |
| ç©ºé¡µè®¡æ•°é‡ç½® | è·¨åˆ†ç±»è®¡æ•°å¹²æ‰° | ç‹¬ç«‹è®¡æ•°ï¼Œé€»è¾‘æ¸…æ™° | æ‰€æœ‰çˆ¬è™« |

---

## ğŸ¯ ä¼˜åŒ–æ”¶ç›Š

### 1. ç¨³å®šæ€§æå‡
- **å‡å°‘ç¿»é¡µå¤±è´¥**: é€šè¿‡ä¼˜åŒ–æ ¡éªŒå’Œå¼‚å¸¸å¤„ç†ï¼Œå‡å°‘äº†ç¿»é¡µè¿‡ç¨‹ä¸­çš„å¤±è´¥
- **æé«˜æ•°æ®å®Œæ•´æ€§**: æ™ºèƒ½å¼‚å¸¸å¤„ç†å‡å°‘äº†å› ä¸´æ—¶é”™è¯¯å¯¼è‡´çš„æ•°æ®ä¸¢å¤±
- **å¢å¼ºå®¹é”™èƒ½åŠ›**: ç½‘ç»œé”™è¯¯å’Œè§£æé”™è¯¯ä¸å†å¯¼è‡´æ•´ä¸ªçˆ¬å–è¿‡ç¨‹åœæ­¢

### 2. å‡†ç¡®æ€§æå‡
- **ç²¾ç¡®æ—¶é—´åˆ¤æ–­**: æ–°çš„æ—¶é—´åŒºé—´æ£€æµ‹é€»è¾‘æ›´åŠ å‡†ç¡®
- **æ¸…æ™°è®¡æ•°é€»è¾‘**: æ¶ˆé™¤äº†é‡å¤è®¡æ•°å’Œè·¨åˆ†ç±»å¹²æ‰°
- **æ™ºèƒ½é‡è¯•æœºåˆ¶**: æ ¹æ®é”™è¯¯ç±»å‹å†³å®šé‡è¯•ç­–ç•¥

### 3. å¯ç»´æŠ¤æ€§æå‡
- **ä»£ç é€»è¾‘æ¸…æ™°**: æ¯ä¸ªä¼˜åŒ–éƒ½å¢åŠ äº†è¯¦ç»†çš„æ³¨é‡Š
- **é”™è¯¯å¤„ç†ç»Ÿä¸€**: å»ºç«‹äº†ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æ¨¡å¼
- **è®¡æ•°é€»è¾‘è§„èŒƒ**: ç»Ÿä¸€äº†ç©ºé¡µè®¡æ•°çš„é‡ç½®é€»è¾‘

---

## ğŸ” æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•
- [ ] æµ‹è¯•è‡ªç„¶èµ„æºéƒ¨çˆ¬è™«çš„ç¿»é¡µåœæ­¢æ¡ä»¶
- [ ] æµ‹è¯•ä½å»ºéƒ¨çˆ¬è™«çš„æ—¶é—´åŒºé—´è¿‡æ»¤
- [ ] æµ‹è¯•å¹¿ä¸œçœçˆ¬è™«çš„ä¸¤æ­¥æ ¡éªŒé‡è¯•
- [ ] æµ‹è¯•æ‰€æœ‰çˆ¬è™«çš„å¼‚å¸¸æ¢å¤èƒ½åŠ›

### 2. è¾¹ç•Œæµ‹è¯•
- [ ] æµ‹è¯•ç©ºé¡µæ£€æµ‹çš„è¾¹ç•Œæƒ…å†µ
- [ ] æµ‹è¯•æ—¶é—´åŒºé—´çš„è¾¹ç•Œæ—¥æœŸ
- [ ] æµ‹è¯•ç½‘ç»œå¼‚å¸¸æ—¶çš„é‡è¯•æœºåˆ¶
- [ ] æµ‹è¯•åˆ†ç±»åˆ‡æ¢æ—¶çš„è®¡æ•°é‡ç½®

### 3. æ€§èƒ½æµ‹è¯•
- [ ] æµ‹è¯•ä¼˜åŒ–åçš„çˆ¬å–é€Ÿåº¦
- [ ] æµ‹è¯•é‡è¯•æœºåˆ¶å¯¹æ€§èƒ½çš„å½±å“
- [ ] æµ‹è¯•å¼‚å¸¸å¤„ç†çš„å¼€é”€
- [ ] æµ‹è¯•å†…å­˜ä½¿ç”¨æƒ…å†µ

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### 1. çŸ­æœŸä¼˜åŒ–ï¼ˆv3.0.2ï¼‰
- [ ] æ·»åŠ ç¿»é¡µè¿›åº¦çš„æŒä¹…åŒ–ä¿å­˜
- [ ] ä¼˜åŒ–å¹¿ä¸œçœçš„å¤šç­–ç•¥ç¿»é¡µé€»è¾‘
- [ ] å¢åŠ ç¿»é¡µå¤±è´¥çš„è‡ªé€‚åº”é‡è¯•é—´éš”

### 2. ä¸­æœŸä¼˜åŒ–ï¼ˆv3.1.0ï¼‰
- [ ] å®ç°ç¿»é¡µç­–ç•¥çš„åŠ¨æ€é€‰æ‹©
- [ ] æ·»åŠ ç¿»é¡µæ€§èƒ½ç›‘æ§
- [ ] ä¼˜åŒ–å¤§æ•°æ®é‡ä¸‹çš„ç¿»é¡µæ•ˆç‡

### 3. é•¿æœŸä¼˜åŒ–ï¼ˆv3.2.0ï¼‰
- [ ] å®ç°æ™ºèƒ½ç¿»é¡µé¢„æµ‹
- [ ] æ·»åŠ ç¿»é¡µæ¨¡å¼çš„å­¦ä¹ èƒ½åŠ›
- [ ] æ”¯æŒè‡ªå®šä¹‰ç¿»é¡µç­–ç•¥

---

## ğŸ“‹ ä»£ç è´¨é‡æ£€æŸ¥

### å·²é€šè¿‡æ£€æŸ¥
- [x] æ¶ˆé™¤äº†æ­»ä»£ç 
- [x] ä¿®å¤äº†é€»è¾‘é”™è¯¯
- [x] ç»Ÿä¸€äº†ä»£ç é£æ ¼
- [x] å¢åŠ äº†è¯¦ç»†æ³¨é‡Š
- [x] æ”¹è¿›äº†é”™è¯¯å¤„ç†

### å»ºè®®æ£€æŸ¥
- [ ] è¿è¡Œå•å…ƒæµ‹è¯•éªŒè¯åŠŸèƒ½
- [ ] è¿›è¡Œä»£ç å®¡æŸ¥
- [ ] æµ‹è¯•è¾¹ç•Œæ¡ä»¶
- [ ] éªŒè¯æ€§èƒ½å½±å“

---

**ä¼˜åŒ–å®Œæˆ**: 2025.10.29  
**ç‰ˆæœ¬**: v3.0.1  
**ä¸‹æ¬¡ä¼˜åŒ–**: å»ºè®®åœ¨v3.0.2ç‰ˆæœ¬ä¸­ç»§ç»­ä¼˜åŒ–

