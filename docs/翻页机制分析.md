# å„éƒ¨é—¨çˆ¬è™«ç¿»é¡µæœºåˆ¶åˆ†æ

**æ›´æ–°æ—¥æœŸ**: 2025.10.29  
**ç‰ˆæœ¬**: v3.0.1

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†å¯¹ä¸‰ä¸ªæ”¿åºœéƒ¨é—¨çš„æ”¿ç­–æ•°æ®çˆ¬å–ï¼Œæ¯ä¸ªéƒ¨é—¨çš„ç¿»é¡µæœºåˆ¶å› ç½‘ç«™ç»“æ„ä¸åŒè€Œæœ‰æ˜¾è‘—å·®å¼‚ã€‚

## ğŸ›ï¸ 1. ä½æˆ¿å’ŒåŸä¹¡å»ºè®¾éƒ¨ (NationalSpider)

### ğŸ”§ ç¿»é¡µå®ç°æ–¹å¼
- **APIç±»å‹**: RESTful API + JSONå“åº”
- **ç¿»é¡µå‚æ•°**: `pageNo` (é¡µç ) + `pageSize` (é¡µå¤§å°)
- **é¡µå¤§å°**: 30æ¡/é¡µ
- **è¯·æ±‚æ–¹å¼**: GETæ–¹æ³•
- **URL**: `https://www.mohurd.gov.cn/api-gateway/jpaas-publish-server/front/page/build/unit`

### ğŸ“Š ç¿»é¡µæœºåˆ¶ç‰¹ç‚¹

#### 1. **å‚æ•°ç»“æ„**
```python
param_json = {
    "pageNo": page_no,        # å½“å‰é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
    "pageSize": page_size,     # æ¯é¡µ30æ¡
    "loadEnabled": True,
    "search": "{}"
}
```

#### 2. **ç¿»é¡µå¾ªç¯é€»è¾‘**
```python
while True:  # æ— å›ºå®šé¡µæ•°é™åˆ¶ï¼Œæ ¹æ®å†…å®¹è‡ªåŠ¨åœæ­¢
    # å‘é€APIè¯·æ±‚
    params['paramJson'] = json.dumps(param_json)
    
    # è§£æHTMLå“åº”å†…å®¹
    html_content = data.get('data', {}).get('html', '')
    
    # æ£€æŸ¥æ˜¯å¦æ— å†…å®¹
    if not html_content:
        break  # æ— HTMLå†…å®¹ï¼Œåœæ­¢ç¿»é¡µ
    
    # æ›´æ–°æ—¶é—´åŒºé—´è·Ÿè¸ª
    if è¶…å‡ºæ—¶é—´èŒƒå›´:
        consecutive_out_of_range += 1
        if consecutive_out_of_range >= 5:  # è¿ç»­5é¡µè¶…å‡ºèŒƒå›´ï¼Œåœæ­¢
            break
    
    page_no += 1
```

#### 3. **ç¿»é¡µåœæ­¢æ¡ä»¶**
- âœ… **è‡ªåŠ¨åœæ­¢**: å½“è¿”å›çš„HTMLå†…å®¹ä¸ºç©ºæ—¶
- âœ… **æ—¶é—´èŒƒå›´åœæ­¢**: è¿ç»­5é¡µè¶…å‡ºç›®æ ‡æ—¶é—´èŒƒå›´æ—¶
- âœ… **æ‰‹åŠ¨åœæ­¢**: ç”¨æˆ·ç‚¹å‡»åœæ­¢æŒ‰é’®æ—¶
- âœ… **æ— é™ç¿»é¡µ**: ç†è®ºä¸Šå¯ä»¥æ— é™ç¿»é¡µï¼ˆæ— ä¸Šé™ï¼‰

#### 4. **ç‰¹ç‚¹åˆ†æ**
- **ä¼˜ç‚¹**: 
  - APIå“åº”å¿«é€Ÿ
  - æ•°æ®æ ¼å¼ç¨³å®šï¼ˆè¿”å›HTMLç‰‡æ®µï¼‰
  - æ”¯æŒæ—¶é—´èŒƒå›´è‡ªåŠ¨è¿‡æ»¤
  - æ— éœ€å¤æ‚ä¼šè¯ç®¡ç†
  
- **ç¼ºç‚¹**:
  - è¿”å›HTMLè€Œéç»“æ„åŒ–JSON
  - éœ€è¦è§£æHTMLæå–æ•°æ®
  - å“åº”å†…å®¹ä¸ç¨³å®šï¼Œå¯èƒ½å‡ºç°ç©ºHTML

---

## ğŸ›ï¸ 2. å¹¿ä¸œçœäººæ°‘æ”¿åºœ (GuangdongSpider)

### ğŸ”§ ç¿»é¡µå®ç°æ–¹å¼
- **APIç±»å‹**: POSTè¡¨å•æäº¤ + HTMLå“åº”
- **ç¿»é¡µå‚æ•°**: `Pager.PageIndex` (é¡µç ) + `Pager.PageSize` (é¡µå¤§å°)
- **é¡µå¤§å°**: 20æ¡/é¡µ
- **è¯·æ±‚æ–¹å¼**: POSTæ–¹æ³•
- **URL**: `https://gd.pkulaw.com/china/search/RecordSearch`

### ğŸ“Š ç¿»é¡µæœºåˆ¶ç‰¹ç‚¹

#### 1. **å‚æ•°ç»“æ„**
```python
search_params = {
    'Pager.PageIndex': str(page_index),     # å½“å‰é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
    'Pager.PageSize': str(page_size),       # æ¯é¡µ20æ¡
    'OldPageIndex': str(old_page_index),     # ä¸Šä¸€é¡µç´¢å¼•ï¼ˆç¿»é¡µæ ¡éªŒï¼‰
    # ... å…¶ä»–æœç´¢å‚æ•°
}
```

#### 2. **ä¸¤æ­¥ç¿»é¡µæœºåˆ¶**
è¯¥éƒ¨é—¨é‡‡ç”¨**ä¸¤æ­¥ç¿»é¡µæ ¡éªŒæœºåˆ¶**ï¼š

```python
def _request_page_with_check(self, page_index, search_params, old_page_index=None):
    """ä¸¤æ­¥ç¿»é¡µæœºåˆ¶"""
    
    # æ­¥éª¤1: ç¿»é¡µæ ¡éªŒæ¥å£
    check_url = "https://gd.pkulaw.com/china/search/RecordSearchCheck"
    check_resp = self.session.post(check_url, data=check_params, ...)
    
    # æ­¥éª¤2: æ•°æ®è¯·æ±‚æ¥å£
    search_url = "https://gd.pkulaw.com/china/search/RecordSearch"
    search_resp = self.session.post(search_url, data=search_params, ...)
    
    return search_resp
```

#### 3. **ç¿»é¡µå¾ªç¯é€»è¾‘**
```python
page_index = 1
max_pages = 999999  # æ— ä¸Šé™
empty_page_count = 0
max_empty_pages = 10  # è¿ç»­ç©ºé¡µé™åˆ¶

while page_index <= max_pages and empty_page_count < max_empty_pages:
    # æ„å»ºæœç´¢å‚æ•°
    post_data = self._get_search_parameters(
        keywords=keywords,
        category_code=category_code,
        page_index=page_index,
        page_size=20
    )
    
    # ä¸¤æ­¥ç¿»é¡µè¯·æ±‚
    resp = self._request_page_with_check(page_index, post_data)
    
    if len(page_policies) == 0:
        empty_page_count += 1
        if empty_page_count >= max_empty_pages:
            break
    else:
        empty_page_count = 0  # é‡ç½®ç©ºé¡µè®¡æ•°
    
    page_index += 1
```

#### 4. **å¤šç§ç¿»é¡µç­–ç•¥**
å¹¿ä¸œçœçˆ¬è™«å®ç°äº†**4ç§ä¸åŒçš„ç¿»é¡µç­–ç•¥**ï¼š

##### ç­–ç•¥1: åˆ†ç±»éå†ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰
- éå†æ‰€æœ‰åˆ†ç±»ï¼ˆ7ä¸ªä¸»è¦åˆ†ç±»ï¼‰
- æ¯ä¸ªåˆ†ç±»åˆ†åˆ«ç¿»é¡µ
- é¡µå¤§å°: 20æ¡/é¡µ
- æœ€å¤§è¿ç»­ç©ºé¡µ: 10é¡µ

##### ç­–ç•¥2: å¿«é€Ÿæœç´¢ï¼ˆæ–°å¢ï¼‰
- è·³è¿‡åˆ†ç±»éå†
- ç›´æ¥ä½¿ç”¨é«˜çº§æœç´¢
- é¡µå¤§å°: 50æ¡/é¡µï¼ˆæ›´å¤§ï¼‰
- ç¿»é¡µé€Ÿåº¦æ›´å¿«

##### ç­–ç•¥3: é‡å¤ç¿»é¡µæ ¡éªŒ
- ä½¿ç”¨`OldPageIndex`å‚æ•°
- ç¡®ä¿ç¿»é¡µæœ‰æ•ˆ
- é˜²æ­¢é‡å¤è¯·æ±‚

##### ç­–ç•¥4: ä¼˜åŒ–ç¿»é¡µï¼ˆå¤‡ç”¨ï¼‰
- æ›´å¤§çš„é¡µå¤§å°ï¼ˆ100æ¡/é¡µï¼‰
- é™åˆ¶æ€»é¡µæ•°ï¼ˆ500é¡µï¼‰
- é€‚ç”¨äºå¤§é‡æ•°æ®æ£€ç´¢

#### 5. **ç¿»é¡µåœæ­¢æ¡ä»¶**
- âœ… **è¿ç»­ç©ºé¡µåœæ­¢**: è¿ç»­10é¡µæ— æ•°æ®æ—¶åœæ­¢
- âœ… **æ‰‹åŠ¨åœæ­¢**: ç”¨æˆ·ç‚¹å‡»åœæ­¢æŒ‰é’®æ—¶
- âœ… **è®¿é—®é™åˆ¶åœæ­¢**: æ£€æµ‹åˆ°è®¿é—®é™åˆ¶æ—¶åœæ­¢
- âœ… **ä¼šè¯å¤±è´¥åœæ­¢**: ä¼šè¯è½®æ¢å¤±è´¥æ—¶åœæ­¢

#### 6. **ç‰¹ç‚¹åˆ†æ**
- **ä¼˜ç‚¹**: 
  - æ”¯æŒå¤šç§ç¿»é¡µç­–ç•¥
  - ä¸¤æ­¥æ ¡éªŒæœºåˆ¶æé«˜æˆåŠŸç‡
  - æ”¯æŒåˆ†ç±»éå†å’Œå¿«é€Ÿæœç´¢
  - è‡ªåŠ¨å¤„ç†è®¿é—®é™åˆ¶
  
- **ç¼ºç‚¹**:
  - ç¿»é¡µæœºåˆ¶å¤æ‚
  - éœ€è¦ç»´æŠ¤ä¼šè¯çŠ¶æ€
  - éœ€è¦å¤„ç†OldPageIndexå‚æ•°
  - å“åº”æ—¶é—´è¾ƒé•¿

---

## ğŸ›ï¸ 3. è‡ªç„¶èµ„æºéƒ¨ (MNRSpider)

### ğŸ”§ ç¿»é¡µå®ç°æ–¹å¼
- **APIç±»å‹**: GETå‚æ•° + æœç´¢ç»“æœé¡µé¢
- **ç¿»é¡µå‚æ•°**: `page` (é¡µç ) + `perpage` (æ¯é¡µæ¡æ•°)
- **é¡µå¤§å°**: 20æ¡/é¡µ
- **è¯·æ±‚æ–¹å¼**: GETæ–¹æ³•
- **URL**: `https://search.mnr.gov.cn/was5/web/search`

### ğŸ“Š ç¿»é¡µæœºåˆ¶ç‰¹ç‚¹

#### 1. **å‚æ•°ç»“æ„**
```python
params = {
    'channelid': '216640',           # å›ºå®šé¢‘é“ID
    'searchword': search_query,      # æœç´¢å…³é”®è¯
    'page': page,                    # å½“å‰é¡µç 
    'perpage': 20,                   # æ¯é¡µ20æ¡
    'searchtype': 'title',           # æœç´¢æ ‡é¢˜
    'orderby': 'RELEVANCE'          # æŒ‰ç›¸å…³æ€§æ’åº
}

# æ—¶é—´è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
if start_date:
    params['starttime'] = start_date
if end_date:
    params['endtime'] = end_date
```

#### 2. **ç¿»é¡µå¾ªç¯é€»è¾‘**
```python
page = 1
max_pages = 999999  # æ— ä¸Šé™
consecutive_empty_pages = 0
max_consecutive_empty = 3  # è¿ç»­ç©ºé¡µé™åˆ¶ï¼ˆä»…3é¡µï¼‰

while page <= self.max_pages:
    # å‘é€æœç´¢è¯·æ±‚
    resp = requests.get(self.search_api, params=params)
    
    # è§£æHTMLå“åº”
    soup = BeautifulSoup(resp.text, 'html.parser')
    policies = self._parse_search_results(soup)
    
    if len(policies) == 0:
        consecutive_empty_pages += 1
        if consecutive_empty_pages >= 3:
            break  # è¿ç»­3é¡µæ— æ•°æ®ï¼Œåœæ­¢ç¿»é¡µ
    else:
        consecutive_empty_pages = 0
    
    page += 1
```

#### 3. **ç¿»é¡µåœæ­¢æ¡ä»¶**
- âœ… **è¿ç»­ç©ºé¡µåœæ­¢**: è¿ç»­3é¡µæ— æ•°æ®æ—¶åœæ­¢
- âœ… **æ‰‹åŠ¨åœæ­¢**: ç”¨æˆ·ç‚¹å‡»åœæ­¢æŒ‰é’®æ—¶
- âœ… **åˆ†ç±»å®Œæˆ**: å½“å‰åˆ†ç±»æ‰€æœ‰é¡µé¢çˆ¬å–å®Œæ¯•

#### 4. **åˆ†ç±»éå†æœºåˆ¶**
```python
# è‡ªç„¶èµ„æºéƒ¨æ”¯æŒæŒ‰åˆ†ç±»çˆ¬å–
for category_name in categories_to_search:
    category_config = self.categories[category_name]
    
    # ä¸ºæ¯ä¸ªåˆ†ç±»æ„å»ºæœç´¢å‚æ•°
    if category_name in self.categories:
        category_code = self.categories[category_name]['code']
        search_query = f"themecat=({category_code})"
    
    # å¯¹è¯¥åˆ†ç±»è¿›è¡Œç¿»é¡µ
    page = 1
    while page <= max_pages:
        # ... ç¿»é¡µé€»è¾‘
        page += 1
```

#### 5. **ç‰¹ç‚¹åˆ†æ**
- **ä¼˜ç‚¹**: 
  - ç¿»é¡µæœºåˆ¶ç®€å•ç›´è§‚
  - æ”¯æŒåˆ†ç±»éå†
  - æ”¯æŒæ—¶é—´èŒƒå›´è¿‡æ»¤
  - URLå‚æ•°æ¸…æ™°
  - å“åº”é€Ÿåº¦å¿«
  
- **ç¼ºç‚¹**:
  - éœ€è§£æHTMLæœç´¢ç»“æœ
  - ç©ºé¡µæ£€æµ‹ä¸å¤Ÿæ•æ„Ÿï¼ˆä»…3é¡µï¼‰
  - åˆ†é¡µå‚æ•°è¾ƒå¤š
  - æ— é«˜çº§æœç´¢API

---

## ğŸ“Š ç¿»é¡µæœºåˆ¶å¯¹æ¯”åˆ†æ

| ç‰¹å¾ | ä½å»ºéƒ¨ | å¹¿ä¸œçœ | è‡ªç„¶èµ„æºéƒ¨ |
|------|--------|--------|------------|
| **APIç±»å‹** | RESTful JSON | POSTè¡¨å• | GETå‚æ•° |
| **é¡µå¤§å°** | 30æ¡/é¡µ | 20æ¡/é¡µ | 20æ¡/é¡µ |
| **ç¿»é¡µå‚æ•°** | pageNo | PageIndex | page |
| **è¯·æ±‚æ–¹å¼** | GET | POST | GET |
| **ç¿»é¡µæ ¡éªŒ** | âŒ æ— éœ€æ ¡éªŒ | âœ… ä¸¤æ­¥æ ¡éªŒ | âŒ æ— éœ€æ ¡éªŒ |
| **æœ€å¤§è¿ç»­ç©ºé¡µ** | 5é¡µ | 10é¡µ | 3é¡µ |
| **ä¼šè¯ç®¡ç†** | ç®€å• | å¤æ‚ï¼ˆéœ€è¦ä¼šè¯è½®æ¢ï¼‰ | ç®€å• |
| **åˆ†ç±»éå†** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆ7ä¸ªåˆ†ç±»ï¼‰ | âœ… æ”¯æŒï¼ˆ23ä¸ªåˆ†ç±»ï¼‰ |
| **æ—¶é—´è¿‡æ»¤** | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| **ç¿»é¡µç­–ç•¥** | å•ä¸€ | 4ç§ç­–ç•¥ | å•ä¸€ |

---

## ğŸ” å…³é”®ä»£ç ä½ç½®

### ä½å»ºéƒ¨ (NationalSpider)
- **æ–‡ä»¶**: `src/space_planning/spider/national.py`
- **ç¿»é¡µå‡½æ•°**: `crawl_policies()` (ç¬¬61-387è¡Œ)
- **å…³é”®é€»è¾‘**: ç¬¬106-277è¡Œ

### å¹¿ä¸œçœ (GuangdongSpider)
- **æ–‡ä»¶**: `src/space_planning/spider/guangdong.py`
- **ç¿»é¡µå‡½æ•°**: `crawl_policies()` (ç¬¬692-959è¡Œ)
- **ä¸¤æ­¥æ ¡éªŒ**: `_request_page_with_check()` (ç¬¬180-273è¡Œ)
- **å…³é”®é€»è¾‘**: ç¬¬762-859è¡Œï¼ˆåˆ†ç±»éå†ç¿»é¡µï¼‰

### è‡ªç„¶èµ„æºéƒ¨ (MNRSpider)
- **æ–‡ä»¶**: `src/space_planning/spider/mnr.py`
- **ç¿»é¡µå‡½æ•°**: `crawl_policies()` (ç¬¬72-378è¡Œ)
- **å…³é”®é€»è¾‘**: ç¬¬134-200è¡Œï¼ˆåˆ†ç±»ç¿»é¡µï¼‰

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### 1. ä½å»ºéƒ¨
- âœ… **å·²å®Œæˆ**: æ—¶é—´åŒºé—´æ™ºèƒ½åœæ­¢
- ğŸ’¡ **å»ºè®®**: å¢åŠ è¿”å›æ•°æ®éªŒè¯ï¼Œç¡®ä¿HTMLæœ‰æ•ˆ

### 2. å¹¿ä¸œçœ
- âœ… **å·²å®Œæˆ**: å¤šç§ç¿»é¡µç­–ç•¥ã€ä¼šè¯è½®æ¢
- ğŸ’¡ **å»ºè®®**: 
  - ä¼˜åŒ–ä¸¤æ­¥æ ¡éªŒæœºåˆ¶ï¼Œå‡å°‘è¯·æ±‚æ¬¡æ•°
  - å¢åŠ ç¿»é¡µå¤±è´¥é‡è¯•æœºåˆ¶
  - æ·»åŠ ç¿»é¡µè¿›åº¦æŒä¹…åŒ–

### 3. è‡ªç„¶èµ„æºéƒ¨
- âœ… **å·²å®Œæˆ**: åˆ†ç±»éå†ã€æ—¶é—´è¿‡æ»¤
- ğŸ’¡ **å»ºè®®**: 
  - å¢åŠ è¿ç»­ç©ºé¡µæ£€æµ‹æ•æ„Ÿåº¦ï¼ˆç”±3é¡µæå‡åˆ°5é¡µï¼‰
  - ä¼˜åŒ–HTMLè§£æé€»è¾‘
  - æ·»åŠ æœç´¢è¯é«˜äº®å¤„ç†

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å¹¿ä¸œçœä¸¤æ­¥ç¿»é¡µæ ¡éªŒæœºåˆ¶è¯¦è§£

```python
def _request_page_with_check(self, page_index, search_params, old_page_index=None):
    """
    å¹¿ä¸œçœç‹¬ç‰¹çš„ç¿»é¡µæœºåˆ¶ï¼š
    
    1. å…ˆè¯·æ±‚æ ¡éªŒæ¥å£ï¼Œç¡®ä¿ç¿»é¡µæœ‰æ•ˆ
    2. å†è¯·æ±‚æ•°æ®æ¥å£ï¼Œè·å–å®é™…æ•°æ®
    
    è¿™ç§æœºåˆ¶å¯ä»¥ï¼š
    - é˜²æ­¢æ¶æ„çˆ¬è™«
    - ç¡®ä¿ç¿»é¡µé¡ºåºæ­£ç¡®
    - æé«˜æ•°æ®è·å–æˆåŠŸç‡
    """
    
    # ç¬¬1æ­¥ï¼šç¿»é¡µæ ¡éªŒ
    check_params = {
        'PageIndex': page_index,
        'OldPageIndex': old_page_index or '',
        'SessionId': self.session.cookies.get('JSESSIONID', ''),
        # ...
    }
    check_resp = self.session.post(check_url, data=check_params)
    
    # ç¬¬2æ­¥ï¼šæ•°æ®è¯·æ±‚
    search_params['OldPageIndex'] = old_page_index or ''
    search_resp = self.session.post(search_url, data=search_params)
    
    return search_resp
```

### ä¸‰éƒ¨é—¨ç¿»é¡µå‚æ•°å¯¹æ¯”

```python
# ä½å»ºéƒ¨
param_json = {"pageNo": 1, "pageSize": 30}

# å¹¿ä¸œçœ
search_params = {
    'Pager.PageIndex': '1',
    'Pager.PageSize': '20',
    'OldPageIndex': ''  # ç¿»é¡µæ ¡éªŒç”¨
}

# è‡ªç„¶èµ„æºéƒ¨
params = {
    'page': 1,
    'perpage': 20,
    'channelid': '216640'
}
```

---

## ğŸ“ æ€»ç»“

ä¸‰ä¸ªéƒ¨é—¨çš„ç¿»é¡µæœºåˆ¶å„æœ‰ç‰¹è‰²ï¼š

1. **ä½å»ºéƒ¨**: æœ€ç®€å•ï¼ŒAPIæ¸…æ™°ï¼Œå“åº”å¿«é€Ÿ
2. **å¹¿ä¸œçœ**: æœ€å¤æ‚ï¼Œéœ€è¦ä¸¤æ­¥æ ¡éªŒï¼Œä½†æ”¯æŒå¤šç§ç­–ç•¥
3. **è‡ªç„¶èµ„æºéƒ¨**: ä¸­ç­‰å¤æ‚åº¦ï¼Œæ”¯æŒåˆ†ç±»éå†

æ‰€æœ‰çˆ¬è™«éƒ½å®ç°äº†ï¼š
- âœ… æ™ºèƒ½åœæ­¢æœºåˆ¶ï¼ˆè¿ç»­ç©ºé¡µæ£€æµ‹ï¼‰
- âœ… æ—¶é—´èŒƒå›´è¿‡æ»¤
- âœ… æ‰‹åŠ¨åœæ­¢æ”¯æŒ
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025.10.29  
**ç»´æŠ¤è€…**: ViVi141

