# 空间规划政策合规性分析系统 - 版本管理说明

## 版本历史

### v3.1.0 (2025.11.11)
**主要更新：**
- ✅ 广东省爬虫接入双请求年份筛选，覆盖 `dfxfg` / `dfzfgz` / `sfjs` / `fljs` 四大分类
- ✅ 列表 `related-info` + 详情 `pub_date` 双重校验，自动过滤跨年记录
- ✅ 新增 `export_guangdong_policies_excel.py`，输出全分类、全年份的 Excel 报表

**详细变更：**
1. **爬虫逻辑重构**
   - 实现 `ClassSearch → RecordSearch` 双阶段请求
   - 移除 `china` 接口映射，所有请求走真实分类入口
   - 日志新增“总年份数量”提示，便于核对 20 世纪的年份可用性

2. **数据导出能力**
   - Excel 导出仅依赖标准库，避免第三方依赖缺失
   - 导出字段：分类名称 / 年份 / 政策标题 / 政策链接

3. **项目整洁度**
   - 清理 `build/`、`dist/`、`__pycache__/` 等临时构建目录
   - 删除空日志 `guangdong_counter.log`

**技术细节：**
- 新增：`scripts/export_guangdong_policies_excel.py`
- 修改：`src/space_planning/spider/guangdong.py`
- 修改：`src/space_planning/__init__.py`
- 修改：`src/space_planning/core/config.py`
- 修改：`docs/pkulaw_year_filter_reverse.md`
- 修改：`README.md`、`CHANGELOG.md`、`版本管理说明.md`

**已知问题：**
- 爬虫状态监控对话框在爬虫运行时仍存在崩溃风险，建议待后续版本修复

---

### v3.0.2 (2025.11.02)
**主要更新：**
- ⚠️ **重要说明**：爬虫状态监控功能目前在爬虫执行时不可用，将在后续版本中修复
- ✅ 修复代理认证问题，明确区分API认证和代理连接认证
- ✅ 修复guangdong.py中的time变量冲突错误
- ✅ 增强爬虫状态对话框错误处理，避免崩溃
- ✅ 改进代理认证提示，支持IP白名单设置指导

**详细变更：**
1. **代理认证修复**
   - 改进快代理私密代理的认证处理逻辑
   - 明确SecretId/SecretKey仅用于API调用
   - 支持IP白名单或用户名密码认证
   - 在407错误时提供详细的解决指导

2. **代码错误修复**
   - 修复guangdong.py中所有函数内部的`import time`语句（共10处）
   - 统一使用模块级别的`time`导入
   - 修复`UnboundLocalError`错误

3. **错误处理增强**
   - 添加对话框关闭标记机制
   - 改进异常捕获和处理
   - 统一使用安全的状态获取方法
   - 防止崩溃传播

4. **项目清理**
   - 删除多余的HTML样本文件
   - 删除临时分析文档

**技术细节：**
- 修改文件：`src/space_planning/spider/persistent_proxy_manager.py`
- 修改文件：`src/space_planning/spider/guangdong.py`
- 修改文件：`src/space_planning/gui/crawler_status_dialog.py`
- 修改文件：`src/space_planning/gui/main_window.py`
- 删除文件：`guangdong_spider_sample.html`, `mnr_spider_sample.html`, `national_spider_sample.html`, `HTML结构分析总结.md`
- 涉及功能：代理认证、错误处理、代码修复、项目清理

**已知问题：**
- 爬虫状态监控功能在爬虫执行时不可用，将在后续版本中修复

---

### v3.0.1 (2025.10.29)
**主要更新：**
- ✅ 修复模块导入路径问题，确保程序能正确启动
- ✅ 修复数据库连接泄漏问题，使用finally块确保连接关闭
- ✅ 修复线程锁泄漏问题，改进异常处理
- ✅ 修复全局变量线程安全问题，确保锁保护
- ✅ 代码优化改进，提升性能和稳定性
- ✅ 清理临时文件，保持项目目录整洁

**详细变更：**
1. **模块导入修复**
   - 修复`main.py`中模块导入路径错误
   - 在程序入口添加`src`目录到Python路径
   - 解决`ModuleNotFoundError`问题

2. **资源管理优化**
   - 修复数据库连接泄漏问题
   - 修复线程锁泄漏问题
   - 修复全局变量线程安全问题
   - 使用finally块确保资源正确释放

3. **代码质量提升**
   - 优化字符串处理逻辑
   - 修复硬编码路径问题
   - 改进异常处理机制
   - 优化GUI响应性

4. **项目清理**
   - 清理源代码目录下的`__pycache__`目录和`.pyc`文件
   - 更新`.gitignore`文件，添加临时文件规则

**技术细节：**
- 修改文件：`src/space_planning/main.py`
- 修改文件：`src/space_planning/core/database.py`
- 修改文件：`src/space_planning/spider/persistent_proxy_manager.py`
- 修改文件：`src/space_planning/spider/proxy_pool.py`
- 修改文件：`src/space_planning/gui/main_window.py`
- 修改文件：`src/space_planning/core/config.py`
- 修改文件：`src/space_planning/spider/guangdong.py`
- 修改文件：`src/space_planning/utils/export.py`
- 涉及功能：模块导入、资源管理、代码优化、项目清理

---

### v3.0.0 (2025.7.13)
**主要更新：**
- ✅ 智能代理池系统，实现基于评分的代理选择
- ✅ 增强的重试机制，支持指数退避和自动代理切换
- ✅ 实时状态监控，显示代理IP、评分、响应时间
- ✅ 本地代理缓存，避免重复获取相同代理
- ✅ 修复广东省爬虫分类问题和状态监控错误

**详细变更：**
1. **智能代理池系统**
   - 实现智能代理轮换机制，基于响应时间、成功率、使用频率的评分系统
   - 支持本地代理缓存，避免重复获取相同代理
   - 概率选择策略，高分代理优先使用
   - 详细的代理状态监控和实时显示

2. **增强的重试机制**
   - 指数退避算法，避免频繁重试
   - 自动代理切换，失败时自动更换代理
   - 基于HTTP状态码的智能重试策略
   - 详细的重试日志和状态跟踪

3. **实时状态监控**
   - 爬虫状态对话框显示当前代理IP、评分、响应时间
   - 实时重试次数和成功率统计
   - 颜色编码状态显示，直观反映系统健康度
   - 每秒自动更新状态信息

4. **问题修复**
   - 修复代理池本地缓存问题，解决总是刷新丢弃旧代理的问题
   - 修复爬虫状态监控错误，优化状态更新线程
   - 修复广东省爬虫分类问题，优化数据结构处理

**技术细节：**
- 修改文件：`src/space_planning/spider/proxy_pool.py`
- 修改文件：`src/space_planning/spider/base_crawler.py`
- 修改文件：`src/space_planning/gui/crawler_status_dialog.py`
- 修改文件：`src/space_planning/gui/main_window.py`
- 修改文件：`src/space_planning/spider/guangdong.py`
- 涉及功能：代理管理、重试机制、状态监控、错误处理

---

### v2.2.1 (2025.7.11)
**主要更新：**
- ✅ 新增多线程爬虫功能，大幅提升爬取速度
- ✅ 支持2-10个线程并行爬取广东省政策
- ✅ 实现线程安全的会话管理和数据隔离
- ✅ 添加实时进度监控和错误统计
- ✅ 优化GUI界面，支持多线程选项配置

**详细变更：**
1. **多线程爬虫核心功能**
   - 新增`GuangdongMultiThreadSpider`类
   - 支持并行处理多个政策分类
   - 每个线程独立处理一个分类，避免串行等待
   - 线程安全的会话管理和数据隔离机制

2. **线程安全机制**
   - 每个线程使用独立的requests.Session
   - 自动会话轮换避免访问限制
   - 使用threading.local()确保线程间数据隔离
   - 使用threading.Lock()保护共享统计信息

3. **GUI界面优化**
   - 添加"启用多线程"选项
   - 支持线程数量选择（2-10个）
   - 智能机构检测，仅广东省支持多线程
   - 实时进度显示和统计信息

4. **性能优化**
   - 爬取时间从8小时缩短到1-2小时
   - 智能线程调度和错误处理
   - 详细的性能统计和监控
   - 支持动态调整线程数量

5. **用户体验提升**
   - 实时显示每个线程的爬取进度
   - 统计完成分类数和失败分类数
   - 显示总爬取数量和最终保存数量
   - 完善的错误处理和重试机制

**技术细节：**
- 修改文件：`src/space_planning/spider/guangdong.py`
- 修改文件：`src/space_planning/gui/main_window.py`
- 新增文件：`多线程爬虫使用说明.md`
- 涉及功能：多线程爬虫、GUI界面、性能优化

---

### v2.2.0 (2025.7.10)
**主要更新：**
- ✅ 为所有导出格式添加政策目录功能
- ✅ 修复爬虫状态监控对话框语法错误
- ✅ 优化导出功能的数据解析逻辑
- ✅ 改进多爬虫实例监控支持

**详细变更：**
1. **导出报告目录功能**
   - Word文档：在开头添加目录标题和序号列表，包含政策时间
   - Excel文件：创建独立的"目录"工作表，包含序号、标题、发布日期、层级
   - 文本文件：在开头添加目录部分，使用分隔线区分，包含政策时间
   - Markdown文件：添加二级标题目录，支持锚点链接跳转，包含政策时间

2. **语法错误修复**
   - 修复`StatusUpdateThread`类中访问不存在属性的错误
   - 优化爬虫实例获取逻辑，确保监控功能正常工作
   - 修复导出模块Excel功能中的类型检查问题

3. **技术改进**
   - 统一的数据解析逻辑，支持多种数据格式
   - 针对不同格式特点优化目录显示
   - 完善的错误处理和默认值设置
   - 改进爬虫状态获取机制

4. **用户体验提升**
   - 快速导航：用户可以通过目录快速定位到感兴趣的政策
   - 内容预览：目录提供政策概览，便于了解报告结构
   - 专业格式：符合正式文档的标准格式要求
   - 多格式支持：无论选择哪种导出格式，都能获得目录功能

**技术细节：**
- 修改文件：`src/space_planning/utils/export.py`
- 修改文件：`src/space_planning/gui/crawler_status_dialog.py`
- 涉及功能：数据导出、监控系统、语法修复

---

### v2.1.4 (2025.7.9)
**主要更新：**
- ✅ 导出格式支持Markdown，满足学术与协作需求
- ✅ 导出支持单选、多选、全选，灵活导出所需政策
- ✅ 导出统计信息，导出后显示导出条数和结果
- ✅ 时间选择逻辑BUG修复，切换预设模式时不会自动跳转到自定义
- ✅ 安装包优化，自动生成安装版和ZIP包，附带启动/卸载脚本和详细说明
- ✅ 依赖精简建议，推荐只打包实际用到的包，减少体积和依赖冲突
- ✅ requirements.txt与打包脚本同步更新

**详细变更：**
1. **导出功能增强**
   - 新增Markdown格式导出支持
   - 实现单选、多选、全选导出功能
   - 添加导出统计信息显示

2. **用户体验优化**
   - 修复时间选择逻辑BUG
   - 优化预设模式切换逻辑
   - 改进界面交互体验

3. **安装包优化**
   - 自动生成安装版和ZIP包
   - 附带启动/卸载脚本和详细说明
   - 依赖精简，减少体积和冲突

4. **文档完善**
   - 数据库持久化机制说明
   - README结构优化
   - 版本信息同步更新

**技术细节：**
- 修改文件：`src/space_planning/utils/export.py`
- 修改文件：`src/space_planning/gui/main_window.py`
- 修改文件：`requirements.txt`
- 涉及功能：数据导出、界面交互、安装打包

---

### v2.1.3 (2025.7.8)
**主要更新：**
- ✅ 支持广东省政策分类层级结构
- ✅ 实现父级和子级分类显示
- ✅ 优化政策类型字段显示格式
- ✅ 保持向后兼容性

**详细变更：**
1. **层级分类结构**
   - 父级分类：地方性法规、地方政府规章、规范性文件
   - 子级分类：省级、设区的市、经济特区等细分类型
   - 政策类型显示为"父级分类 > 子级分类"格式

2. **分类系统优化**
   - 重构分类数据结构，支持层级关系
   - 新增`_get_full_category_name`方法生成完整分类名称
   - 保持扁平化分类接口的向后兼容性

3. **用户体验改进**
   - 更清晰的分类层次结构显示
   - 便于用户理解政策类型归属
   - 符合网站实际分类结构

**技术细节：**
- 修改文件：`src/space_planning/spider/guangdong.py`
- 涉及功能：分类管理、数据解析、层级结构

---

### v2.1.3 (2025.7.8)
**主要更新：**
- ✅ 修复广东省爬虫分类显示问题
- ✅ 优化政策类型字段显示逻辑
- ✅ 完善数据传递机制
- ✅ 新增Windows安装程序打包功能

**详细变更：**
1. **GUI界面优化**
   - 修复广东省政策分类名称显示问题
   - 改进政策类型列的显示逻辑
   - 确保分类信息正确传递到界面

2. **数据传递机制完善**
   - 在GUI回调函数中添加category字段解析
   - 在爬虫POLICY_DATA消息中包含分类信息
   - 修复数据流中的分类信息丢失问题

3. **用户体验改进**
   - 广东省政策现在正确显示分类名称（如"地方规范性文件"、"经济特区法规"等）
   - 表格政策类型列显示更加准确和有用

4. **Windows打包功能**
   - 新增PyInstaller打包脚本
   - 支持生成单个可执行文件
   - 支持生成便携版打包
   - 支持生成标准Windows安装程序（Inno Setup）
   - 提供多种打包方式选择
   - 完整的安装向导和卸载功能

**技术细节：**
- 修改文件：`src/space_planning/gui/main_window.py`
- 修改文件：`src/space_planning/spider/guangdong.py`
- 新增文件：`build_complete_installer.py`
- 新增文件：`完整打包.bat`
- 新增文件：`打包说明.md`、`Inno_Setup_安装指南.md`
- 涉及功能：数据传递、界面显示、分类管理、程序打包

---

### v2.0.0 (2025.7.7)
**主要更新：**
- ✅ 广东省爬虫翻页功能完全修复
- ✅ 优化HTML解析逻辑
- ✅ 增强错误处理和监控
- ✅ 完善防反爬虫机制

**详细变更：**
1. **翻页机制重构**
   - 实现两步翻页请求（校验接口 + 数据接口）
   - 添加翻页校验请求机制
   - 优化请求参数和headers设置

2. **HTML解析优化**
   - 基于最新网站结构分析优化解析逻辑
   - 改进政策项目识别算法
   - 增强数据提取准确性

3. **错误处理增强**
   - 添加连续空页计数机制
   - 优化重试逻辑
   - 完善异常处理

4. **监控系统完善**
   - 实时爬虫状态监控
   - 请求成功率统计
   - 性能指标跟踪

---

### v1.0.0 (2025.7.5)
**初始版本：**
- ✅ 基础爬虫功能
- ✅ 数据库管理
- ✅ 合规性分析
- ✅ 数据导出功能

## 版本命名规则

- **主版本号**：重大功能更新或架构变更
- **次版本号**：功能增强和重要修复
- **修订版本号**：bug修复和小幅改进

## 更新日志格式

每次版本更新应包含：
1. 版本号和发布日期
2. 主要更新内容（用✅标记）
3. 详细变更说明
4. 技术细节和涉及文件
5. 已知问题和注意事项

## 维护说明

- 每次重要更新后及时更新此文档
- 保留详细的变更记录便于问题追踪
- 记录已知问题和解决方案
- 标注涉及的核心文件和功能模块 