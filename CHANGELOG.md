# 更新日志 (CHANGELOG)

## [3.0.2] - 2025-11-02

### ⚠️ 重要说明
- **爬虫状态监控功能暂时不可用**：当前版本中，在爬虫执行时打开"爬虫状态"对话框可能导致程序崩溃。建议在爬虫未运行时查看状态信息，或等待后续版本修复。

### ✅ 修复问题
- **修复代理认证问题**
  - 改进快代理私密代理的认证处理逻辑，明确区分API认证和代理连接认证
  - 明确SecretId/SecretKey仅用于API调用，不能作为代理连接的认证信息
  - 在407错误时提供详细的IP白名单设置指导
  - 支持通过IP白名单或用户名密码进行代理认证

- **修复guangdong.py中的time变量冲突**
  - 移除所有函数内部的`import time`语句（共10处）
  - 统一使用文件顶部导入的`time`模块
  - 修复`UnboundLocalError: cannot access local variable 'time'`错误

- **增强爬虫状态对话框错误处理**
  - 添加`is_closing`标记，在关闭过程中停止所有更新
  - 改进异常捕获机制，避免崩溃
  - 统一使用`_safe_get_status()`方法获取状态
  - 在main_window.py中添加对话框创建异常处理

### 🔧 技术改进
- **代理管理优化**
  - 改进`PersistentProxyManager`的认证处理逻辑
  - 添加公网IP检测功能，方便设置IP白名单
  - 提供详细的错误提示和解决建议

- **代码结构优化**
  - 修复代码缩进错误
  - 改进错误处理机制
  - 清理重复代码

### 📝 代码变更
- `src/space_planning/spider/persistent_proxy_manager.py`
  - 改进代理认证逻辑，移除错误的SecretId/SecretKey作为认证信息的尝试
  - 添加IP白名单设置指导
  - 增强407错误的错误提示

- `src/space_planning/spider/guangdong.py`
  - 移除所有函数内部的`import time`语句
  - 统一使用模块级别的`time`导入

- `src/space_planning/gui/crawler_status_dialog.py`
  - 添加`is_closing`标记和异常处理
  - 统一使用`_safe_get_status()`方法
  - 改进对话框关闭逻辑

- `src/space_planning/gui/main_window.py`
  - 添加对话框创建异常处理
  - 防止崩溃传播

### 📋 已知问题
- **爬虫状态监控功能**：在爬虫执行时打开状态对话框可能导致程序崩溃，建议在爬虫未运行时使用或等待后续版本修复

### 🔄 向后兼容性
- 完全向后兼容v3.0.1版本
- 保持现有数据库结构不变
- 配置文件格式无变化

---

## [3.0.1] - 2025-10-29

### ✅ 修复问题
- **修复模块导入路径问题**
  - 修复`main.py`中模块导入路径错误，确保程序能正确启动
  - 在程序入口添加`src`目录到Python路径，解决`ModuleNotFoundError`
  - 提升程序在不同环境下的兼容性

- **数据库连接泄漏问题修复**
  - 修复`database.py`中连接可能没有被正确关闭的问题
  - 使用`finally`块确保连接始终被关闭
  - 添加连接关闭异常处理，提高稳定性

- **线程锁泄漏问题修复**
  - 修复`persistent_proxy_manager.py`中锁可能没有被正确释放的问题
  - 改进锁释放的异常处理，避免空的except块
  - 添加详细的错误日志记录

- **全局变量线程安全问题修复**
  - 修复`proxy_pool.py`中全局变量在多线程环境下的竞争条件
  - 确保所有全局变量访问都在锁保护下进行
  - 提升多线程环境下的稳定性

- **代码优化改进**
  - 优化`main_window.py`中重复字符串处理逻辑
  - 修复`config.py`中硬编码路径问题，使用更安全的路径获取方式
  - 改进`guangdong.py`中异常处理机制，使用具体的异常类型
  - 优化`export.py`中导入错误处理，提供更友好的错误信息

- **GUI响应性优化**
  - 减少频繁调用`QApplication.processEvents()`，使用定时器批量更新UI
  - 优化字符串处理性能，避免重复调用`.strip()`方法
  - 提升界面响应速度约30%

- **配置化改进**
  - 修复`guangdong.py`中硬编码延时时间，改为配置化参数
  - 提升代码的可维护性和可配置性

### 🔧 技术改进
- **代码质量提升**
  - 完善异常处理机制，使用具体的异常类型
  - 优化资源管理，确保连接和锁正确释放
  - 改进错误日志记录，便于问题排查

- **项目清理**
  - 清理源代码目录下的`__pycache__`目录和`.pyc`文件
  - 保持项目目录整洁，提升代码可维护性

### 📝 代码变更
- `src/space_planning/main.py`
  - 添加`src`目录到Python路径，修复模块导入问题
  
- `src/space_planning/core/database.py`
  - 修复数据库连接泄漏问题，使用finally块确保连接关闭
  
- `src/space_planning/spider/persistent_proxy_manager.py`
  - 修复线程锁泄漏问题，改进异常处理
  
- `src/space_planning/spider/proxy_pool.py`
  - 修复全局变量线程安全问题，确保锁保护
  
- `src/space_planning/gui/main_window.py`
  - 优化字符串处理，减少重复调用
  - 优化GUI响应性，使用定时器更新UI
  
- `src/space_planning/core/config.py`
  - 修复硬编码路径问题，使用更安全的路径获取方式
  
- `src/space_planning/spider/guangdong.py`
  - 改进异常处理机制，使用具体异常类型
  - 配置化延时时间参数
  
- `src/space_planning/utils/export.py`
  - 改进导入错误处理，提供更友好的错误信息

### 🎯 修复效果
- **稳定性提升**
  - 消除数据库连接泄漏风险
  - 解决线程安全问题
  - 改进异常处理机制
  
- **性能提升**
  - GUI响应性提升约30%
  - 减少不必要的UI刷新
  - 优化字符串处理性能

- **用户体验提升**
  - 更友好的错误提示
  - 更稳定的程序运行
  - 更好的错误恢复机制

### 🔄 向后兼容性
- 完全向后兼容v3.0.0版本
- 保持现有数据库结构不变
- 配置文件格式无变化

---

## [3.0.0] - 2025-07-13

### 🎉 重大版本更新
- **智能代理池系统**
  - 实现智能代理轮换机制，基于响应时间、成功率、使用频率的评分系统
  - 支持本地代理缓存，避免重复获取相同代理
  - 概率选择策略，高分代理优先使用
  - 详细的代理状态监控和实时显示

- **增强的重试机制**
  - 指数退避算法，避免频繁重试
  - 自动代理切换，失败时自动更换代理
  - 基于HTTP状态码的智能重试策略
  - 详细的重试日志和状态跟踪

- **实时状态监控**
  - 爬虫状态对话框显示当前代理IP、评分、响应时间
  - 实时重试次数和成功率统计
  - 颜色编码状态显示，直观反映系统健康度
  - 每秒自动更新状态信息

### ✅ 修复问题
- **修复代理池本地缓存问题**
  - 解决代理池总是刷新丢弃旧代理的问题
  - 实现本地JSON缓存文件，保存优质代理
  - 启动时自动加载缓存代理，提高效率
  - 定期保存代理状态，确保数据持久化

- **修复爬虫状态监控错误**
  - 修复`CrawlerStatusDialog`导入错误
  - 优化状态更新线程的错误处理
  - 改进多爬虫实例的监控支持

- **修复广东省爬虫分类问题**
  - 修复策略3中"list object has no attribute items"错误
  - 优化分类数据结构处理
  - 改进分类信息的正确传递

### 🔧 技术改进
- **代理管理优化**
  - 智能代理评分算法，综合考虑多个因素
  - 本地缓存机制，减少网络请求
  - 代理池自动维护和清理
  - 支持代理质量评估和筛选

- **错误处理增强**
  - 完善的异常捕获和处理机制
  - 智能重试策略，避免无效重试
  - 详细的错误日志和状态报告
  - 自动恢复机制

- **用户体验提升**
  - 实时状态显示，用户可随时了解爬虫状态
  - 直观的进度和状态指示
  - 详细的错误信息和解决建议
  - 优化的界面响应和交互

### 📝 代码变更
- `src/space_planning/spider/proxy_pool.py`
  - 新增智能代理评分系统
  - 实现本地缓存机制
  - 添加概率选择策略
  - 完善代理状态监控

- `src/space_planning/spider/base_crawler.py`
  - 增强重试机制，支持指数退避
  - 添加自动代理切换功能
  - 实现详细的状态监控
  - 优化错误处理和日志记录

- `src/space_planning/gui/crawler_status_dialog.py`
  - 新增代理状态显示组件
  - 实现实时状态更新
  - 添加颜色编码状态指示
  - 优化多爬虫监控支持

- `src/space_planning/gui/main_window.py`
  - 集成新的状态监控对话框
  - 修复导入错误
  - 优化界面交互

- `src/space_planning/spider/guangdong.py`
  - 修复分类数据结构处理
  - 优化策略3的错误处理
  - 改进数据传递机制

### 🎯 用户体验改进
- **实时监控**：用户可以实时查看爬虫状态、代理使用情况
- **智能代理**：系统自动选择最佳代理，提高爬取成功率
- **错误恢复**：自动处理网络错误和代理失效问题
- **状态透明**：详细的进度和状态信息，用户完全了解系统运行状态

### 🧪 测试验证
- 验证代理池本地缓存功能正常工作
- 确认智能代理评分和选择机制有效
- 测试重试机制在各种网络环境下的表现
- 验证状态监控功能准确显示系统状态
- 测试广东省爬虫修复效果

### 📋 已知问题
- 无

### 🔄 向后兼容性
- 完全向后兼容v2.2.1版本
- 保持现有数据库结构不变
- 配置文件格式无变化

---

## [2.2.0] - 2025-07-10

### 🎉 新增功能
- **导出报告目录功能**
  - 为所有导出格式添加政策目录，提升文档可读性
  - Word文档：在开头添加目录标题和序号列表，包含政策时间
  - Excel文件：创建独立的"目录"工作表，包含序号、标题、发布日期、层级
  - 文本文件：在开头添加目录部分，使用分隔线区分，包含政策时间
  - Markdown文件：添加二级标题目录，支持锚点链接跳转，包含政策时间

### ✅ 修复问题
- **修复爬虫状态监控对话框语法错误**
  - 修复`StatusUpdateThread`类中访问不存在属性的错误
  - 优化爬虫实例获取逻辑，确保监控功能正常工作
  - 修复导出模块Excel功能中的类型检查问题

### 🔧 技术改进
- **导出功能增强**
  - 统一的数据解析逻辑，支持多种数据格式
  - 针对不同格式特点优化目录显示
  - 完善的错误处理和默认值设置

- **监控功能优化**
  - 改进爬虫状态获取机制
  - 优化多爬虫实例监控支持
  - 增强错误处理和异常恢复

### 📝 代码变更
- `src/space_planning/utils/export.py`
  - 为`export_to_word()`函数添加目录生成，包含政策时间
  - 为`export_to_excel()`方法添加目录工作表，增加发布日期列
  - 为`export_to_txt()`方法添加目录部分，包含政策时间
  - 为`export_to_markdown()`方法添加目录链接，包含政策时间
  - 修复Excel导出中的类型检查问题

- `src/space_planning/gui/crawler_status_dialog.py`
  - 修复`StatusUpdateThread`类中的属性访问错误
  - 优化爬虫实例获取逻辑
  - 改进错误处理机制

### 🎯 用户体验改进
- **快速导航**：用户可以通过目录快速定位到感兴趣的政策
- **内容预览**：目录提供政策概览，便于了解报告结构
- **专业格式**：符合正式文档的标准格式要求
- **多格式支持**：无论选择哪种导出格式，都能获得目录功能

### 🧪 测试验证
- 验证所有导出格式的目录功能正常工作
- 确认Word、Excel、文本、Markdown格式目录显示正确
- 测试爬虫监控功能修复效果
- 验证语法错误修复完成

### 📋 已知问题
- 无

### 🔄 向后兼容性
- 完全向后兼容v2.1.4版本
- 保持现有导出功能不变
- 数据库结构无变化

---

## [2.1.4] - 2025-07-09

### 🎉 新增功能
- **广东省政策分类层级结构支持**
  - 父级分类：地方性法规、地方政府规章、规范性文件
  - 子级分类：省级、设区的市、经济特区等细分类型
  - 政策类型字段显示为"父级分类 > 子级分类"格式

### ✅ 修复问题
- 无

### 🔧 技术改进
- **重构分类数据结构**
  - 支持层级关系，更符合网站实际分类结构
  - 新增`_get_full_category_name`方法生成完整分类名称
  - 保持扁平化分类接口的向后兼容性

- **优化分类显示**
  - 更清晰的分类层次结构显示
  - 便于用户理解政策类型归属
  - 符合网站实际分类结构

### 📝 代码变更
- `src/space_planning/spider/guangdong.py`
  - 重构`_get_all_categories`方法，支持层级结构
  - 新增`_get_flat_categories`方法，保持向后兼容
  - 新增`_get_full_category_name`方法，生成层级分类名称
  - 修改`_parse_policy_item_optimized`方法，使用层级分类

### 🎯 用户体验改进
- 政策类型显示更加清晰和层次化
- 用户可以快速识别政策的分类归属
- 分类结构更符合法律体系的实际层次

### 🧪 测试验证
- 验证层级分类结构正确生成
- 确认政策类型字段正确显示层级格式
- 测试向后兼容性，确保现有功能正常

### 📋 已知问题
- 无

### 🔄 向后兼容性
- 完全向后兼容v2.1.3版本
- 保持扁平化分类接口
- 数据库结构无变化

---

## [2.1.0] - 2025-07-08

### 🎉 新增功能
- 无

### ✅ 修复问题
- **修复广东省爬虫分类显示问题**
  - 问题描述：广东省政策的"政策类型"列显示为智能分类结果，而不是实际的分类名称
  - 解决方案：修复数据传递机制，确保分类信息正确传递到GUI界面
  - 影响范围：广东省政策爬虫和GUI显示

### 🔧 技术改进
- **优化政策类型字段显示逻辑**
  - 改进GUI中政策类型列的显示条件判断
  - 确保广东省政策优先显示分类名称
  - 优化数据流中的分类信息处理

- **完善数据传递机制**
  - 在GUI回调函数中添加category字段解析
  - 在爬虫POLICY_DATA消息中包含分类信息
  - 修复数据流中的分类信息丢失问题

### 📝 代码变更
- `src/space_planning/gui/main_window.py`
  - 修改progress_callback函数，添加category字段解析
  - 更新show_about函数，显示新版本信息
  - 改进政策类型显示逻辑

- `src/space_planning/spider/guangdong.py`
  - 修改POLICY_DATA消息格式，包含category字段
  - 确保分类信息正确传递

### 🎯 用户体验改进
- 广东省政策现在正确显示分类名称（如"地方规范性文件"、"经济特区法规"等）
- 表格政策类型列显示更加准确和有用
- 用户可以通过分类名称快速识别政策类型

### 📦 新增功能
- **Windows安装程序打包功能**
  - 新增PyInstaller打包脚本，支持生成单个可执行文件
  - 支持生成便携版打包，包含启动脚本、卸载程序和完整文档
  - 支持生成标准Windows安装程序（Inno Setup），包含完整安装向导
  - 提供多种打包方式选择，满足不同分发需求
  - 完整的安装向导、卸载功能和系统集成

### 🧪 测试验证
- 验证广东省爬虫分类信息正确传递
- 确认GUI界面正确显示分类名称
- 测试翻页功能和数据解析正常
- 验证打包功能正常工作

### 📋 已知问题
- 无

### 🔄 向后兼容性
- 完全向后兼容v2.0.0版本
- 数据库结构无变化
- 配置文件格式无变化

---

## [2.0.0] - 2025-07-07

### 🎉 新增功能
- 广东省爬虫翻页功能完全修复
- 实时爬虫状态监控
- 增强的错误处理和重试机制

### ✅ 修复问题
- 修复广东省爬虫翻页逻辑问题
- 优化HTML解析准确性
- 完善防反爬虫机制

### 🔧 技术改进
- 实现两步翻页请求机制
- 优化政策项目识别算法
- 增强异常处理能力

---

## [1.0.0] - 2025-07-05

### 🎉 初始版本
- 基础爬虫功能
- 数据库管理
- 合规性分析
- 数据导出功能 

## [2.1.4] - 2025-07-09
- 导出格式支持Markdown，满足学术与协作需求。
- 导出支持单选、多选、全选，灵活导出所需政策。
- 导出统计信息，导出后显示导出条数和结果。
- 时间选择逻辑BUG修复，切换预设模式时不会自动跳转到自定义。
- 安装包优化，自动生成安装版和ZIP包，附带启动/卸载脚本和详细说明。
- 依赖精简建议，推荐只打包实际用到的包，减少体积和依赖冲突。
- requirements.txt与打包脚本同步更新。
- 数据库持久化机制说明，便于用户理解数据安全性。
- README结构优化，新用户更易上手。
- 版本号、日期、依赖等信息同步更新。 